<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>WebClient vs OkHttp SSE å¯¹æ¯”</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f0f0f0; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
        }
        .comparison { 
            display: flex; 
            gap: 20px; 
            margin-top: 20px; 
        }
        .side { 
            flex: 1; 
            border: 2px solid #ddd; 
            padding: 15px; 
            border-radius: 5px; 
        }
        .webclient { border-color: #007bff; }
        .okhttp { border-color: #28a745; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .webclient button { background: #007bff; }
        .okhttp button { background: #28a745; }
        .result { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            min-height: 100px; 
            background: #f9f9f9; 
        }
        .debug { 
            background: #e8f4f8; 
            padding: 10px; 
            margin: 10px 0; 
            font-family: monospace; 
            max-height: 200px; 
            overflow-y: auto; 
            font-size: 12px;
        }
        .highlight { 
            background: yellow; 
            font-weight: bold; 
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.connecting { background: #ffeaa7; }
        .status.connected { background: #55a3ff; color: white; }
        .status.completed { background: #00b894; color: white; }
        .status.error { background: #e17055; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ WebClient vs OkHttp SSE æµå¼å¯¹æ¯”æµ‹è¯•</h1>
        <p><strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>æ¯”è¾ƒä¸¤ç§æŠ€æœ¯å®ç° SSE æµå¼æ•°æ®å¤„ç†çš„æ•ˆæœå·®å¼‚</p>
        
        <div class="comparison">
            <!-- WebClient æµ‹è¯•åŒºåŸŸ -->
            <div class="side webclient">
                <h3>ğŸ“˜ WebClient (å“åº”å¼)</h3>
                <div class="status" id="webClientStatus">å¾…æµ‹è¯•</div>
                <button onclick="testWebClient()">å¼€å§‹ WebClient æµ‹è¯•</button>
                <button onclick="stopWebClient()">åœæ­¢</button>
                
                <div><strong>å®æ—¶æ‹¼æ¥ç»“æœï¼š</strong></div>
                <div id="webClientResult" class="result">ç­‰å¾…æµ‹è¯•...</div>
                
                <div><strong>å¤„ç†æ—¥å¿—ï¼š</strong></div>
                <div id="webClientDebug" class="debug"></div>
            </div>
            
            <!-- OkHttp æµ‹è¯•åŒºåŸŸ -->
            <div class="side okhttp">
                <h3>ğŸ“— OkHttp (å›è°ƒå¼)</h3>
                <div class="status" id="okHttpStatus">å¾…æµ‹è¯•</div>
                <button onclick="testOkHttp()">å¼€å§‹ OkHttp æµ‹è¯•</button>
                <button onclick="stopOkHttp()">åœæ­¢</button>
                
                <div><strong>å®æ—¶æ‹¼æ¥ç»“æœï¼š</strong></div>
                <div id="okHttpResult" class="result">ç­‰å¾…æµ‹è¯•...</div>
                
                <div><strong>å¤„ç†æ—¥å¿—ï¼š</strong></div>
                <div id="okHttpDebug" class="debug"></div>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <h4>ğŸ” æŠ€æœ¯å¯¹æ¯”è¯´æ˜ï¼š</h4>
            <ul>
                <li><strong>WebClientï¼š</strong>Spring WebFlux å“åº”å¼ç¼–ç¨‹ï¼ŒåŸºäº Reactor Flux æµå¼å¤„ç†</li>
                <li><strong>OkHttpï¼š</strong>Square å…¬å¸ HTTP å®¢æˆ·ç«¯ï¼ŒåŸºäºå›è°ƒæœºåˆ¶çš„å¼‚æ­¥å¤„ç†</li>
                <li><strong>é¢„æœŸæ•ˆæœï¼š</strong>ä¸¤è€…éƒ½åº”è¯¥èƒ½å®ç°ç›¸åŒçš„ SSE æµå¼æ•°æ®æ‹¼æ¥æ•ˆæœ</li>
                <li><strong>æ€§èƒ½å·®å¼‚ï¼š</strong>å¯ä»¥è§‚å¯Ÿå“åº”æ—¶é—´ã€å†…å­˜å ç”¨ã€è¿æ¥å¤„ç†æ–¹å¼çš„åŒºåˆ«</li>
            </ul>
        </div>
    </div>

    <script>
        let webClientEventSource = null;
        let okHttpEventSource = null;
        
        // æ·»åŠ çŠ¶æ€è·Ÿè¸ªå˜é‡
        let webClientCompleted = false;
        let okHttpCompleted = false;
        
        function updateStatus(type, status, text) {
            const statusDiv = document.getElementById(type + 'Status');
            statusDiv.className = 'status ' + status;
            statusDiv.textContent = text;
        }
        
        function addDebug(type, message) {
            const debugDiv = document.getElementById(type + 'Debug');
            const time = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        function updateResult(type, content) {
            document.getElementById(type + 'Result').innerHTML = content;
        }
        
        function startSSETest(url, type, eventSourceVar) {
            if (window[eventSourceVar]) {
                window[eventSourceVar].close();
            }
            
            // é‡ç½®å®ŒæˆçŠ¶æ€
            if (type === 'webClient') {
                webClientCompleted = false;
            } else if (type === 'okHttp') {
                okHttpCompleted = false;
            }
            
            let accumulatedText = '';
            let dataCount = 0;
            let startTime = Date.now();
            
            // æ›´æ–°çŠ¶æ€å’Œæ¸…ç©ºæ˜¾ç¤º
            updateStatus(type, 'connecting', 'è¿æ¥ä¸­...');
            updateResult(type, 'ğŸ”„ è¿æ¥ä¸­...');
            document.getElementById(type + 'Debug').innerHTML = '';
            addDebug(type, 'ğŸš€ å¼€å§‹è¿æ¥: ' + url);
            
            window[eventSourceVar] = new EventSource(url);
            
            window[eventSourceVar].onopen = function() {
                updateStatus(type, 'connected', 'å·²è¿æ¥');
                addDebug(type, 'âœ… è¿æ¥æˆåŠŸï¼Œå¼€å§‹æ¥æ”¶æ•°æ®...');
            };
            
            window[eventSourceVar].onmessage = function(event) {
                dataCount++;
                const elapsed = Date.now() - startTime;
                addDebug(type, `ğŸ“¨ ç¬¬${dataCount}æ¬¡æ¥æ”¶ (${elapsed}ms): "${event.data}"`);
                
                if (event.data === '[DONE]') {
                    // æ ‡è®°ä¸ºå®ŒæˆçŠ¶æ€
                    if (type === 'webClient') {
                        webClientCompleted = true;
                    } else if (type === 'okHttp') {
                        okHttpCompleted = true;
                    }
                    
                    updateStatus(type, 'completed', 'ä¼ è¾“å®Œæˆ');
                    addDebug(type, `ğŸ æ•°æ®æ¥æ”¶å®Œæˆï¼æ€»è®¡ ${dataCount} æ¬¡ï¼Œè€—æ—¶ ${elapsed}ms`);
                    window[eventSourceVar].close();
                    updateResult(type, '<div>âœ… æœ€ç»ˆç»“æœï¼š</div><div>' + accumulatedText + '</div>');
                    return;
                }
                
                // ğŸ”¥ å…³é”®æ‹¼æ¥é€»è¾‘
                const oldText = accumulatedText;
                accumulatedText += event.data;
                
                addDebug(type, `ğŸ”— æ‹¼æ¥: "${oldText}" + "${event.data}" = "<span class="highlight">${accumulatedText}</span>"`);
                
                // å®æ—¶æ›´æ–°æ˜¾ç¤º
                updateResult(type, '<div>ğŸ“ å®æ—¶æ‹¼æ¥å†…å®¹ï¼š</div><div>' + accumulatedText + '</div>');
            };
            
            window[eventSourceVar].onerror = function(error) {
                // æ£€æŸ¥è¿æ¥æ˜¯å¦å·²ç»å®Œæˆï¼Œé¿å…è¯¯æŠ¥é”™è¯¯
                const isCompleted = (type === 'webClient' && webClientCompleted) || 
                                   (type === 'okHttp' && okHttpCompleted);
                                   
                if (isCompleted || window[eventSourceVar].readyState === EventSource.CLOSED) {
                    // è¿æ¥å·²æ­£å¸¸å…³é—­ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                    addDebug(type, 'âœ… è¿æ¥æ­£å¸¸å…³é—­');
                    return;
                }
                
                updateStatus(type, 'error', 'è¿æ¥é”™è¯¯');
                addDebug(type, 'âŒ è¿æ¥é”™è¯¯: ' + JSON.stringify(error));
                updateResult(type, 'âŒ è¿æ¥é”™è¯¯');
            };
        }
        
        function testWebClient() {
            startSSETest('/api/chat/stream/mock?message=WebClientæµå¼æµ‹è¯•', 'webClient', 'webClientEventSource');
        }
        
        function testOkHttp() {
            startSSETest('/api/chat/okhttp/mock?message=OkHttpæµå¼æµ‹è¯•', 'okHttp', 'okHttpEventSource');
        }
        
        function stopWebClient() {
            if (webClientEventSource && webClientEventSource.readyState !== EventSource.CLOSED) {
                webClientEventSource.close();
                updateStatus('webClient', 'error', 'æ‰‹åŠ¨åœæ­¢');
                addDebug('webClient', 'ğŸ›‘ æ‰‹åŠ¨åœæ­¢è¿æ¥');
            }
        }
        
        function stopOkHttp() {
            if (okHttpEventSource && okHttpEventSource.readyState !== EventSource.CLOSED) {
                okHttpEventSource.close();
                updateStatus('okHttp', 'error', 'æ‰‹åŠ¨åœæ­¢');
                addDebug('okHttp', 'ğŸ›‘ æ‰‹åŠ¨åœæ­¢è¿æ¥');
            }
        }
    </script>
</body>
</html>