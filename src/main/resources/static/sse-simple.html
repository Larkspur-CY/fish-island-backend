<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE 流式对话演示</title>
    <style>
        body { 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .chat-container { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            min-height: 400px; 
        }
        .input-area { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        input[type='text'] { 
            flex: 1; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        button { 
            padding: 10px 20px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .message { 
            margin-bottom: 15px; 
            padding: 10px; 
            border-radius: 8px; 
        }
        .user-message { 
            background: #007bff; 
            color: white; 
            margin-left: 80px; 
            text-align: right; 
        }
        .ai-message { 
            background: #f1f1f1; 
            color: #333; 
            margin-right: 80px; 
        }
        .typing { 
            border-left: 3px solid #007bff; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .cursor { animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .test-buttons { margin-bottom: 20px; }
        .test-buttons button { margin-right: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="chat-container">
        <h1>SSE 流式对话演示</h1>
        
        <div class="test-buttons">
            <button onclick="testMockProcess()">Mock 处理流程</button>
            <button onclick="testTypingEffect()">Typing 打字效果</button>
            <button onclick="clearChat()">Clear 清空</button>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="输入您的消息..." onkeypress="handleEnter(event)">
            <button id="sendBtn" onclick="sendMessage()">发送</button>
        </div>
        
        <div id="chatMessages"></div>
    </div>

    <script>
        let currentEventSource = null;
        
        // 添加用户消息
        function addUserMessage(message) {
            const chatDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.textContent = message;
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        
        // 创建 AI 消息容器
        function createAIMessage() {
            const chatDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message typing';
            messageDiv.id = 'current-ai-message';
            chatDiv.appendChild(messageDiv);
            return messageDiv;
        }
        
        // 更新 AI 消息内容
        function updateAIMessage(content, isComplete = false) {
            const messageDiv = document.getElementById('current-ai-message');
            if (messageDiv) {
                if (isComplete) {
                    messageDiv.textContent = content;
                    messageDiv.classList.remove('typing');
                    messageDiv.removeAttribute('id');
                    console.log('消息完成:', content);
                } else {
                    messageDiv.innerHTML = content + '<span class="cursor">|</span>';
                    console.log('正在更新:', content);
                }
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            } else {
                console.error('找不到消息容器');
            }
        }
        
        // 通用 SSE 请求函数
        function startSSERequest(url, inputMessage) {
            if (currentEventSource) {
                currentEventSource.close();
            }
            
            if (inputMessage) {
                addUserMessage(inputMessage);
            }
            
            const aiMessageDiv = createAIMessage();
            let accumulatedText = '';
            
            currentEventSource = new EventSource(url);
            
            currentEventSource.onmessage = function(event) {
                if (event.data === '[DONE]') {
                    updateAIMessage(accumulatedText, true);
                    currentEventSource.close();
                    currentEventSource = null;
                    document.getElementById('sendBtn').disabled = false;
                    return;
                }
                
                // 累积文本内容
                accumulatedText += event.data;
                console.log('收到数据:', event.data, '累积内容:', accumulatedText);
                
                // 实时更新显示
                updateAIMessage(accumulatedText, false);
            };
            
            currentEventSource.onerror = function(error) {
                console.error('SSE 错误:', error);
                updateAIMessage('⚠️ 连接错误，请稍后重试', true);
                currentEventSource = null;
                document.getElementById('sendBtn').disabled = false;
            };
            
            document.getElementById('sendBtn').disabled = true;
        }
        
        // 发送消息
        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;
            
            const url = '/api/chat/stream/typing?text=' + encodeURIComponent(message);
            startSSERequest(url, message);
            
            input.value = '';
        }
        
        // 测试 Mock 处理
        function testMockProcess() {
            const url = '/api/chat/stream/mock?message=测试处理流程';
            startSSERequest(url, null);
        }
        
        // 测试打字效果
        function testTypingEffect() {
            const url = '/api/chat/stream/typing?text=这是一个模拟的AI助手回复，演示流式输出效果。';
            startSSERequest(url, null);
        }
        
        // 清空聊天
        function clearChat() {
            document.getElementById('chatMessages').innerHTML = '';
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
                document.getElementById('sendBtn').disabled = false;
            }
        }
        
        // Enter 键发送
        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>