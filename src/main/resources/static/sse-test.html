<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SSE æ•°æ®æ‹¼æ¥æ¼”ç¤º</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f0f0f0; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
        }
        .test-area { 
            border: 2px solid #007bff; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        .result { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            min-height: 100px; 
            background: #f9f9f9; 
        }
        .debug { 
            background: #e8f4f8; 
            padding: 10px; 
            margin: 10px 0; 
            font-family: monospace; 
            max-height: 200px; 
            overflow-y: auto; 
        }
        .highlight { 
            background: yellow; 
            font-weight: bold; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ SSE æ•°æ®æ‹¼æ¥å®æ—¶æ¼”ç¤º</h1>
        <p><strong>é‡ç‚¹æ¼”ç¤ºï¼š</strong>æ¯æ¬¡æ¥æ”¶åˆ°æ•°æ®æ—¶ï¼Œå¦‚ä½•å°†æ–°æ•°æ®æ‹¼æ¥åˆ°ä¹‹å‰çš„ç´¯ç§¯å†…å®¹ä¸Š</p>
        
        <div class="test-area">
            <h3>ğŸ“ æ‰“å­—æ•ˆæœæµ‹è¯•ï¼ˆé€å­—ç¬¦æ‹¼æ¥ï¼‰</h3>
            <button onclick="testTyping()">å¼€å§‹æ‰“å­—æµ‹è¯•</button>
            <button onclick="stopAll()">åœæ­¢</button>
            <div><strong>å®æ—¶æ‹¼æ¥ç»“æœï¼š</strong></div>
            <div id="typingResult" class="result">ç­‰å¾…æµ‹è¯•...</div>
            <div><strong>æ‹¼æ¥è¿‡ç¨‹æ—¥å¿—ï¼š</strong></div>
            <div id="typingDebug" class="debug"></div>
        </div>
        
        <div class="test-area">
            <h3>âš™ï¸ å¤„ç†æµç¨‹æµ‹è¯•ï¼ˆåˆ†æ­¥æ‹¼æ¥ï¼‰</h3>
            <button onclick="testMock()">å¼€å§‹æµç¨‹æµ‹è¯•</button>
            <button onclick="stopAll()">åœæ­¢</button>
            <div><strong>å®æ—¶æ‹¼æ¥ç»“æœï¼š</strong></div>
            <div id="mockResult" class="result">ç­‰å¾…æµ‹è¯•...</div>
            <div><strong>æ‹¼æ¥è¿‡ç¨‹æ—¥å¿—ï¼š</strong></div>
            <div id="mockDebug" class="debug"></div>
        </div>
        
        <div class="test-area">
            <h3>ğŸš€ OkHttp ç‰ˆæœ¬æµ‹è¯•ï¼ˆä¸ WebClient å¯¹æ¯”ï¼‰</h3>
            <button onclick="testOkHttpMock()">OkHttp Mock æµ‹è¯•</button>
            <button onclick="stopAll()">åœæ­¢</button>
            <div><strong>å®æ—¶æ‹¼æ¥ç»“æœï¼š</strong></div>
            <div id="okhttpResult" class="result">ç­‰å¾…æµ‹è¯•...</div>
            <div><strong>æ‹¼æ¥è¿‡ç¨‹æ—¥å¿—ï¼š</strong></div>
            <div id="okhttpDebug" class="debug"></div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let currentTest = '';
        
        function addDebug(testType, message) {
            const debugDiv = document.getElementById(testType + 'Debug');
            const time = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        function updateResult(testType, content) {
            document.getElementById(testType + 'Result').innerHTML = content;
        }
        
        function startSSE(url, testType) {
            if (eventSource) {
                eventSource.close();
            }
            
            currentTest = testType;
            let accumulatedText = '';
            let dataCount = 0;
            
            // æ¸…ç©ºä¹‹å‰çš„æ˜¾ç¤º
            updateResult(testType, 'ğŸ”„ è¿æ¥ä¸­...');
            document.getElementById(testType + 'Debug').innerHTML = '';
            addDebug(testType, 'å¼€å§‹è¿æ¥: ' + url);
            
            eventSource = new EventSource(url);
            
            eventSource.onopen = function() {
                addDebug(testType, 'âœ… è¿æ¥æˆåŠŸï¼Œç­‰å¾…æ•°æ®...');
            };
            
            eventSource.onmessage = function(event) {
                dataCount++;
                addDebug(testType, `ğŸ“¨ ç¬¬${dataCount}æ¬¡æ¥æ”¶: "${event.data}"`);
                
                if (event.data === '[DONE]') {
                    addDebug(testType, 'ğŸ æ•°æ®æ¥æ”¶å®Œæˆï¼');
                    eventSource.close();
                    updateResult(testType, '<div>âœ… æœ€ç»ˆç»“æœï¼š</div><div>' + accumulatedText + '</div>');
                    return;
                }
                
                // ğŸ”¥ å…³é”®æ‹¼æ¥é€»è¾‘
                const oldText = accumulatedText;
                accumulatedText += event.data;
                
                addDebug(testType, `ğŸ”— æ‹¼æ¥å‰: "${oldText}"`);
                addDebug(testType, `â• æ–°å¢å†…å®¹: "${event.data}"`);
                addDebug(testType, `ğŸ”— æ‹¼æ¥å: "<span class="highlight">${accumulatedText}</span>"`);
                addDebug(testType, '---');
                
                // å®æ—¶æ›´æ–°æ˜¾ç¤º
                updateResult(testType, '<div>ğŸ“ å®æ—¶æ‹¼æ¥å†…å®¹ï¼š</div><div>' + accumulatedText + '</div>');
            };
            
            eventSource.onerror = function(error) {
                addDebug(testType, 'âŒ è¿æ¥é”™è¯¯: ' + JSON.stringify(error));
                updateResult(testType, 'âŒ è¿æ¥é”™è¯¯');
            };
        }
        
        function testTyping() {
            startSSE('/api/chat/stream/typing?text=Hello World! æ•°æ®æ‹¼æ¥æ¼”ç¤º', 'typing');
        }
        
        function testMock() {
            startSSE('/api/chat/stream/mock?message=æµ‹è¯•æ•°æ®æ‹¼æ¥æµç¨‹', 'mock');
        }
        
        function testOkHttpMock() {
            startSSE('/api/chat/okhttp/mock?message=OkHttpæµ‹è¯•æ•°æ®æ‹¼æ¥', 'okhttp');
        }
        
        function stopAll() {
            if (eventSource) {
                eventSource.close();
                addDebug(currentTest, 'ğŸ›‘ æ‰‹åŠ¨åœæ­¢è¿æ¥');
            }
        }
    </script>
</body>
</html>