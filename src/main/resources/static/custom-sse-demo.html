<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸‰ç§SSEæ ¼å¼å¯¹æ¯”æ¼”ç¤º</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        .header h1 {
            margin: 0;
            font-size: 2.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .test-sections { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 25px; 
            margin-top: 20px; 
        }
        .test-section { 
            border: 2px solid #e1e8ed; 
            padding: 20px; 
            border-radius: 12px; 
            background: #fafbfc;
            transition: all 0.3s ease;
        }
        .test-section:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .section-custom { border-left: 5px solid #3498db; }
        .section-ai { border-left: 5px solid #e74c3c; }
        .section-upload { border-left: 5px solid #2ecc71; }
        .section-comparison { border-left: 5px solid #f39c12; }
        
        h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.3em;
        }
        
        button { 
            padding: 12px 20px; 
            margin: 8px 5px; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-custom { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-ai { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-upload { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-stop { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:disabled { 
            background: #bdc3c7; 
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .result { 
            border: 2px solid #e1e8ed; 
            padding: 20px; 
            margin: 15px 0; 
            min-height: 120px; 
            background: white;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }
        
        .event-display {
            margin: 8px 0;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #ddd;
        }
        .event-message { border-left-color: #3498db; background: #f8f9fa; }
        .event-progress { border-left-color: #f39c12; background: #fff3cd; }
        .event-thinking { border-left-color: #9b59b6; background: #f4ecf7; }
        .event-typing { border-left-color: #1abc9c; background: #e8f8f5; }
        .event-complete { border-left-color: #27ae60; background: #d4edda; }
        .event-error { border-left-color: #e74c3c; background: #f8d7da; }
        .event-done { border-left-color: #6c757d; background: #e2e3e5; font-weight: bold; }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
            margin: 8px 0;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status.connecting { background: #fff3cd; color: #856404; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.completed { background: #d1ecf1; color: #0c5460; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .comparison-info {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }
        .comparison-info h4 {
            margin-top: 0;
            font-size: 1.4em;
        }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .feature-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ä¸‰ç§SSEæ ¼å¼å¯¹æ¯”æ¼”ç¤º</h1>
            <p>ä½“éªŒ Flux&lt;String&gt;ã€Flux&lt;ServerSentEvent&lt;T&gt;&gt; å’Œ Flux&lt;CustomSseEvent&lt;T&gt;&gt; ä¸‰ç§ä¸åŒçš„SSEå®ç°æ–¹å¼</p>
        </div>
        
        <div class="test-sections">
            <!-- æ ¼å¼1ï¼šä¼ ç»ŸSSEå­—ç¬¦ä¸²æ ¼å¼ -->
            <div class="test-section section-custom">
                <h3>ğŸ“‹ æ ¼å¼1ï¼šFlux&lt;String&gt;</h3>
                <div class="status" id="customStatus">å¾…æµ‹è¯•</div>
                
                <div class="input-group">
                    <label>å¤„ç†æ¶ˆæ¯ï¼š</label>
                    <input type="text" id="customMessage" value="ä¼ ç»ŸSSEæ ¼å¼æµ‹è¯•" placeholder="è¾“å…¥å¤„ç†æ¶ˆæ¯">
                </div>
                
                <button class="btn-custom" onclick="testCustomSse()">æµ‹è¯•ä¼ ç»Ÿæ ¼å¼</button>
                <button class="btn-stop" onclick="stopCustom()">åœæ­¢</button>
                
                <div><strong>è¿”å›ï¼šSSEæ ¼å¼å­—ç¬¦ä¸²</strong></div>
                <div id="customResult" class="result">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            
            <!-- æ ¼å¼2ï¼šSpringåŸç”ŸServerSentEvent -->
            <div class="test-section section-ai">
                <h3>ğŸŒŸ æ ¼å¼2ï¼šFlux&lt;ServerSentEvent&lt;T&gt;&gt;</h3>
                <div class="status" id="serverSentStatus">å¾…æµ‹è¯•</div>
                
                <div class="input-group">
                    <label>å¤„ç†æ¶ˆæ¯ï¼š</label>
                    <input type="text" id="serverSentMessage" value="SpringåŸç”Ÿæ ¼å¼æµ‹è¯•" placeholder="è¾“å…¥å¤„ç†æ¶ˆæ¯">
                </div>
                
                <button class="btn-ai" onclick="testServerSentEvent()">æµ‹è¯•SpringåŸç”Ÿ</button>
                <button class="btn-stop" onclick="stopServerSent()">åœæ­¢</button>
                
                <div><strong>è¿”å›ï¼šSpringæ ‡å‡†SSEå¯¹è±¡</strong></div>
                <div id="serverSentResult" class="result">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            
            <!-- æ ¼å¼3ï¼šè‡ªå®šä¹‰æ³›å‹äº‹ä»¶å¯¹è±¡ -->
            <div class="test-section section-upload">
                <h3>ğŸš€ æ ¼å¼3ï¼šFlux&lt;CustomSseEvent&lt;T&gt;&gt;</h3>
                <div class="status" id="customEventStatus">å¾…æµ‹è¯•</div>
                
                <div class="input-group">
                    <label>å¤„ç†æ¶ˆæ¯ï¼š</label>
                    <input type="text" id="customEventMessage" value="è‡ªå®šä¹‰äº‹ä»¶å¯¹è±¡æµ‹è¯•" placeholder="è¾“å…¥å¤„ç†æ¶ˆæ¯">
                </div>
                
                <button class="btn-upload" onclick="testCustomSseEvent()">æµ‹è¯•è‡ªå®šä¹‰å¯¹è±¡</button>
                <button class="btn-stop" onclick="stopCustomEvent()">åœæ­¢</button>
                
                <div><strong>è¿”å›ï¼šCustomSseEventå¯¹è±¡ï¼ˆJSONæ ¼å¼ï¼‰</strong></div>
                <div id="customEventResult" class="result">ç­‰å¾…æµ‹è¯•...</div>
            </div>
            
            <!-- AIèŠå¤©å¯¹æ¯”æµ‹è¯• -->
            <div class="test-section section-comparison">
                <h3>ğŸ¤– AIèŠå¤©å¯¹æ¯”æµ‹è¯•</h3>
                <div class="status" id="aiCompareStatus">å¾…æµ‹è¯•</div>
                
                <div class="input-group">
                    <label>æ‚¨çš„é—®é¢˜ï¼š</label>
                    <textarea id="aiQuestion" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜">ä»€ä¹ˆæ˜¯Server-Sent Eventsï¼Ÿ</textarea>
                </div>
                
                <button class="btn-ai" onclick="testAiChatString()">ä¼ ç»Ÿæ ¼å¼ AI</button>
                <button class="btn-custom" onclick="testAiChatServerSent()">SpringåŸç”Ÿ AI</button>
                <button class="btn-upload" onclick="testAiChatCustomEvent()">è‡ªå®šä¹‰å¯¹è±¡ AI</button>
                <button class="btn-stop" onclick="stopAiCompare()">åœæ­¢</button>
                
                <div><strong>AIå›å¤å¯¹æ¯”ï¼š</strong></div>
                <div id="aiCompareResult" class="result">ç­‰å¾…æé—®...</div>
            </div>
            
            <!-- æ–‡ä»¶ä¸Šä¼ è¿›åº¦å¯¹æ¯” -->
            <div class="test-section section-upload">
                <h3>ğŸ“¤ æ–‡ä»¶ä¸Šä¼ è¿›åº¦å¯¹æ¯”</h3>
                <div class="status" id="uploadCompareStatus">å¾…æµ‹è¯•</div>
                
                <div class="input-group">
                    <label>æ–‡ä»¶åï¼š</label>
                    <input type="text" id="uploadFilename" value="document.pdf" placeholder="è¾“å…¥æ–‡ä»¶å">
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="uploadProgress"></div>
                </div>
                
                <button class="btn-ai" onclick="testFileUploadString()">ä¼ ç»Ÿæ ¼å¼ä¸Šä¼ </button>
                <button class="btn-upload" onclick="testFileUploadCustomEvent()">è‡ªå®šä¹‰å¯¹è±¡ä¸Šä¼ </button>
                <button class="btn-stop" onclick="stopUploadCompare()">å–æ¶ˆä¸Šä¼ </button>
                
                <div><strong>ä¸Šä¼ è¯¦æƒ…å¯¹æ¯”ï¼š</strong></div>
                <div id="uploadCompareResult" class="result">é€‰æ‹©æ–‡ä»¶å¼€å§‹ä¸Šä¼ ...</div>
            </div>
            
            <!-- å¯¹æ¯”ä¼ ç»ŸSSE -->
            <div class="test-section section-comparison">
                <h3>âš–ï¸ æ ¼å¼å¯¹æ¯”æ€»ç»“</h3>
                <div class="status" id="traditionalStatus">å¾…æµ‹è¯•</div>
                
                <button class="btn-custom" onclick="testAllFormatsComparison()">ä¸€é”®å¯¹æ¯”ä¸‰ç§æ ¼å¼</button>
                <button class="btn-stop" onclick="stopTraditional()">åœæ­¢</button>
                
                <div><strong>ä¸‰ç§æ ¼å¼å¯¹æ¯”ç»“æœï¼š</strong></div>
                <div id="traditionalResult" class="result">ç­‰å¾…å¯¹æ¯”æµ‹è¯•...</div>
            </div>
        </div>
        
        <div class="comparison-info">
            <h4>ğŸŒŸ ä¸‰ç§SSEæ ¼å¼å¯¹æ¯”</h4>
            <div class="feature-list">
                <div class="feature-item">
                    <strong>ğŸ–¼ï¸ Flux&lt;String&gt;</strong><br>
                    ä¼ ç»Ÿæ ¼å¼ï¼Œè¿”å›SSEæ ¼å¼å­—ç¬¦ä¸²ï¼Œå®Œå…¨æ§åˆ¶æ ¼å¼
                </div>
                <div class="feature-item">
                    <strong>ğŸŒ… Flux&lt;ServerSentEvent&lt;T&gt;&gt;</strong><br>
                    Springæ ‡å‡†æ ¼å¼ï¼Œè‡ªåŠ¨å¤„ç†SSEåè®®ï¼Œç±»å‹å®‰å…¨
                </div>
                <div class="feature-item">
                    <strong>ğŸš€ Flux&lt;CustomSseEvent&lt;T&gt;&gt;</strong><br>
                    è‡ªå®šä¹‰æ³›å‹æ ¼å¼ï¼Œä¿æŒå®Œæ•´å¯¹è±¡ç»“æ„ï¼Œä¸šåŠ¡è¯­ä¹‰æ¸…æ™°
                </div>
                <div class="feature-item">
                    <strong>ğŸ“ˆ æ€§èƒ½å¯¹æ¯”</strong><br>
                    å¯ä»¥é€šè¿‡æ§åˆ¶å°ç½‘ç»œé¢æ¿æŸ¥çœ‹ä¸åŒæ ¼å¼çš„ä¼ è¾“æ•ˆç‡
                </div>
            </div>
        </div>
    </div>

    <script>
        let customEventSource = null;
        let serverSentEventSource = null;
        let customEventObjectSource = null;
        let aiCompareEventSource = null;
        let uploadCompareEventSource = null;
        let traditionalEventSource = null;
        
        function updateStatus(type, status, text) {
            const statusDiv = document.getElementById(type + 'Status');
            if (statusDiv) {
                statusDiv.className = 'status ' + status;
                statusDiv.textContent = text;
            }
        }
        
        function displayEvent(type, eventData) {
            const resultDiv = document.getElementById(type + 'Result');
            if (!resultDiv) return;
            
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-display event-' + (eventData.event || 'message');
            
            let content = `<strong>[${eventData.event || 'message'}]</strong> `;
            if (eventData.timestamp) {
                const time = new Date(eventData.timestamp).toLocaleTimeString();
                content += `<small>(${time})</small><br>`;
            }
            content += eventData.data || '';
            
            if (eventData.progress !== undefined) {
                content += `<br><em>è¿›åº¦: ${eventData.progress}%</em>`;
                
                // æ›´æ–°è¿›åº¦æ¡ï¼ˆä»…æ–‡ä»¶ä¸Šä¼ ï¼‰
                if (type === 'uploadCompare' && document.getElementById('uploadProgress')) {
                    document.getElementById('uploadProgress').style.width = eventData.progress + '%';
                }
            }
            if (eventData.status) {
                content += ` <span style="color: #666;">[${eventData.status}]</span>`;
            }
            
            eventDiv.innerHTML = content;
            resultDiv.appendChild(eventDiv);
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        // ========== æ ¼å¼1ï¼šä¼ ç»Ÿ Flux<String> æµ‹è¯• ==========
        
        function testCustomSse() {
            const message = document.getElementById('customMessage').value;
            const url = `/api/chat/stream/custom-sse?message=${encodeURIComponent(message)}`;
            startEventSourceTest(url, 'custom');
        }
        
        // ========== æ ¼å¼2ï¼šSpring åŸç”Ÿ ServerSentEvent æµ‹è¯• ==========
        
        function testServerSentEvent() {
            const message = document.getElementById('serverSentMessage').value;
            const url = `/api/chat/stream/server-sent-event?message=${encodeURIComponent(message)}`;
            startEventSourceTest(url, 'serverSent');
        }
        
        // ========== æ ¼å¼3ï¼šè‡ªå®šä¹‰ CustomSseEvent<T> å¯¹è±¡æµ‹è¯• ==========
        
        function testCustomSseEvent() {
            const message = document.getElementById('customEventMessage').value;
            const url = `/api/chat/stream/custom-sse-event?message=${encodeURIComponent(message)}`;
            startEventSourceTest(url, 'customEvent');
        }
        
        // ========== AI èŠå¤©å¯¹æ¯”æµ‹è¯• ==========
        
        async function testAiChatString() {
            const question = document.getElementById('aiQuestion').value;
            
            updateStatus('aiCompare', 'connecting', 'è¿æ¥ä¸­ (ä¼ ç»Ÿæ ¼å¼)...');
            document.getElementById('aiCompareResult').innerHTML = '';
            
            try {
                const response = await fetch('/api/chat/stream/ai-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({ question: question })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                updateStatus('aiCompare', 'connected', 'å·²è¿æ¥ (ä¼ ç»Ÿæ ¼å¼)');
                await processStreamResponse(response, 'aiCompare');
                
            } catch (error) {
                updateStatus('aiCompare', 'error', 'è¯·æ±‚å¤±è´¥');
                displayEvent('aiCompare', { 
                    event: 'error', 
                    data: 'ä¼ ç»Ÿæ ¼å¼è¯·æ±‚å¤±è´¥: ' + error.message, 
                    timestamp: Date.now() 
                });
            }
        }
        
        async function testAiChatServerSent() {
            const question = document.getElementById('aiQuestion').value;
            
            updateStatus('aiCompare', 'connecting', 'è¿æ¥ä¸­ (SpringåŸç”Ÿ)...');
            
            try {
                const response = await fetch('/api/chat/stream/ai-server-sent-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({ question: question })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                updateStatus('aiCompare', 'connected', 'å·²è¿æ¥ (SpringåŸç”Ÿ)');
                await processStreamResponse(response, 'aiCompare');
                
            } catch (error) {
                updateStatus('aiCompare', 'error', 'è¯·æ±‚å¤±è´¥');
                displayEvent('aiCompare', { 
                    event: 'error', 
                    data: 'SpringåŸç”Ÿæ ¼å¼è¯·æ±‚å¤±è´¥: ' + error.message, 
                    timestamp: Date.now() 
                });
            }
        }
        
        async function testAiChatCustomEvent() {
            const question = document.getElementById('aiQuestion').value;
            
            updateStatus('aiCompare', 'connecting', 'è¿æ¥ä¸­ (è‡ªå®šä¹‰å¯¹è±¡)...');
            
            try {
                const response = await fetch('/api/chat/stream/ai-custom-sse-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({ question: question })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                updateStatus('aiCompare', 'connected', 'å·²è¿æ¥ (è‡ªå®šä¹‰å¯¹è±¡)');
                await processStreamResponse(response, 'aiCompare');
                
            } catch (error) {
                updateStatus('aiCompare', 'error', 'è¯·æ±‚å¤±è´¥');
                displayEvent('aiCompare', { 
                    event: 'error', 
                    data: 'è‡ªå®šä¹‰å¯¹è±¡æ ¼å¼è¯·æ±‚å¤±è´¥: ' + error.message, 
                    timestamp: Date.now() 
                });
            }
        }
        
        // ========== æ–‡ä»¶ä¸Šä¼ å¯¹æ¯”æµ‹è¯• ==========
        
        async function testFileUploadString() {
            const filename = document.getElementById('uploadFilename').value;
            
            updateStatus('uploadCompare', 'connecting', 'å‡†å¤‡ä¸Šä¼  (ä¼ ç»Ÿæ ¼å¼)...');
            document.getElementById('uploadCompareResult').innerHTML = '';
            document.getElementById('uploadProgress').style.width = '0%';
            
            try {
                const response = await fetch('/api/chat/stream/file-upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({ filename: filename })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                updateStatus('uploadCompare', 'connected', 'ä¸Šä¼ ä¸­ (ä¼ ç»Ÿæ ¼å¼)...');
                await processStreamResponse(response, 'uploadCompare');
                
            } catch (error) {
                updateStatus('uploadCompare', 'error', 'ä¸Šä¼ å¤±è´¥');
                displayEvent('uploadCompare', { 
                    event: 'error', 
                    data: 'ä¼ ç»Ÿæ ¼å¼ä¸Šä¼ å¤±è´¥: ' + error.message, 
                    timestamp: Date.now() 
                });
            }
        }
        
        async function testFileUploadCustomEvent() {
            const filename = document.getElementById('uploadFilename').value;
            
            updateStatus('uploadCompare', 'connecting', 'å‡†å¤‡ä¸Šä¼  (è‡ªå®šä¹‰å¯¹è±¡)...');
            document.getElementById('uploadProgress').style.width = '0%';
            
            try {
                const response = await fetch('/api/chat/stream/file-upload-custom-sse-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({ filename: filename })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                updateStatus('uploadCompare', 'connected', 'ä¸Šä¼ ä¸­ (è‡ªå®šä¹‰å¯¹è±¡)...');
                await processStreamResponse(response, 'uploadCompare');
                
            } catch (error) {
                updateStatus('uploadCompare', 'error', 'ä¸Šä¼ å¤±è´¥');
                displayEvent('uploadCompare', { 
                    event: 'error', 
                    data: 'è‡ªå®šä¹‰å¯¹è±¡æ ¼å¼ä¸Šä¼ å¤±è´¥: ' + error.message, 
                    timestamp: Date.now() 
                });
            }
        }
        
        // ========== é€šç”¨å¤„ç†å‡½æ•° ==========
        
        async function processStreamResponse(response, type) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                
                if (done) {
                    updateStatus(type, 'completed', 'ä¼ è¾“å®Œæˆ');
                    break;
                }
                
                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    if (line.trim() === '') continue;
                    
                    // å¤„ç† event: è¡Œ
                    if (line.startsWith('event:')) {
                        // åœ¨SSEä¸­ï¼Œeventå’Œdataæ˜¯åˆ†å¼€çš„è¡Œï¼Œè¿™é‡Œåªæ˜¯è®°å½•eventç±»å‹
                        continue;
                    }
                    
                    if (line.startsWith('data:')) {
                        const data = line.slice(5).trim();
                        
                        // æ£€æŸ¥å®Œæˆæ ‡å¿—
                        if (data === '[DONE]') {
                            updateStatus(type, 'completed', 'ä¼ è¾“å®Œæˆ');
                            return;
                        }
                        
                        try {
                            // å°è¯•è§£æä¸ºJSONå¯¹è±¡ï¼ˆCustomSseEvent æ ¼å¼ï¼‰
                            const jsonData = JSON.parse(data);
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸º done äº‹ä»¶ä¸”åŒ…å« [DONE] æ•°æ®
                            if (jsonData.event === 'done' && jsonData.data === '[DONE]') {
                                displayEvent(type, jsonData);
                                updateStatus(type, 'completed', 'ä¼ è¾“å®Œæˆ');
                                return;
                            }
                            
                            displayEvent(type, jsonData);
                        } catch (e) {
                            // æ™®é€šæ–‡æœ¬æ•°æ®
                            displayEvent(type, { 
                                event: 'message', 
                                data: data, 
                                timestamp: Date.now() 
                            });
                        }
                    }
                }
            }
        }
        
        function startEventSourceTest(url, type) {
            const eventSourceVar = type + 'EventSource';
            
            if (window[eventSourceVar]) {
                window[eventSourceVar].close();
            }
            
            updateStatus(type, 'connecting', 'è¿æ¥ä¸­...');
            document.getElementById(type + 'Result').innerHTML = '';
            
            window[eventSourceVar] = new EventSource(url);
            
            window[eventSourceVar].onopen = function() {
                updateStatus(type, 'connected', 'å·²è¿æ¥');
            };
            
            window[eventSourceVar].onmessage = function(event) {
                try {
                    // å°è¯•è§£æJSONæ•°æ®
                    const eventData = JSON.parse(event.data);
                    displayEvent(type, eventData);
                } catch (e) {
                    // æ™®é€šæ–‡æœ¬æ•°æ®
                    if (event.data === '[DONE]') {
                        updateStatus(type, 'completed', 'ä¼ è¾“å®Œæˆ');
                        window[eventSourceVar].close();
                        return;
                    }
                    
                    displayEvent(type, { 
                        event: 'message', 
                        data: event.data, 
                        timestamp: Date.now() 
                    });
                }
            };
            
            // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ç±»å‹
            ['progress', 'thinking', 'typing', 'complete', 'error', 'done'].forEach(eventType => {
                window[eventSourceVar].addEventListener(eventType, function(event) {
                    let eventData = {
                        event: eventType,
                        data: event.data,
                        timestamp: Date.now()
                    };
                    
                    // å°è¯•è§£æJSONæ•°æ®è·å–æ›´å¤šä¿¡æ¯
                    try {
                        const parsed = JSON.parse(event.data);
                        eventData = { ...eventData, ...parsed };
                    } catch (e) {
                        // å¿½ç•¥è§£æé”™è¯¯ï¼Œä½¿ç”¨åŸå§‹æ•°æ®
                    }
                    
                    displayEvent(type, eventData);
                    
                    if (eventType === 'done' && (event.data === '[DONE]' || eventData.data === '[DONE]')) {
                        updateStatus(type, 'completed', 'ä¼ è¾“å®Œæˆ');
                        window[eventSourceVar].close();
                    } else if (eventType === 'complete') {
                        updateStatus(type, 'completed', 'ä¼ è¾“å®Œæˆ');
                    } else if (eventType === 'error') {
                        updateStatus(type, 'error', 'å‘ç”Ÿé”™è¯¯');
                    }
                });
            });
            
            window[eventSourceVar].onerror = function(error) {
                if (window[eventSourceVar].readyState === EventSource.CLOSED) {
                    return;
                }
                updateStatus(type, 'error', 'è¿æ¥é”™è¯¯');
            };
        }
        
        // ========== ä¸€é”®å¯¹æ¯”æµ‹è¯• ==========
        
        function testAllFormatsComparison() {
            updateStatus('traditional', 'connecting', 'å¼€å§‹ä¸‰ç§æ ¼å¼å¯¹æ¯”æµ‹è¯•...');
            document.getElementById('traditionalResult').innerHTML = '';
            
            // ä¾æ¬¡æµ‹è¯•ä¸‰ç§æ ¼å¼
            setTimeout(() => {
                displayEvent('traditional', { 
                    event: 'message', 
                    data: 'ğŸ”„ å¼€å§‹æµ‹è¯• Flux<String> æ ¼å¼...', 
                    timestamp: Date.now() 
                });
                testCustomSse();
            }, 500);
            
            setTimeout(() => {
                displayEvent('traditional', { 
                    event: 'message', 
                    data: 'ğŸ”„ å¼€å§‹æµ‹è¯• Flux<ServerSentEvent<T>> æ ¼å¼...', 
                    timestamp: Date.now() 
                });
                testServerSentEvent();
            }, 3000);
            
            setTimeout(() => {
                displayEvent('traditional', { 
                    event: 'message', 
                    data: 'ğŸ”„ å¼€å§‹æµ‹è¯• Flux<CustomSseEvent<T>> æ ¼å¼...', 
                    timestamp: Date.now() 
                });
                testCustomSseEvent();
            }, 6000);
            
            setTimeout(() => {
                displayEvent('traditional', { 
                    event: 'complete', 
                    data: 'âœ… ä¸‰ç§æ ¼å¼å¯¹æ¯”æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹å„ä¸ªé¢æ¿çš„è¾“å‡ºç»“æœã€‚', 
                    timestamp: Date.now() 
                });
                updateStatus('traditional', 'completed', 'å¯¹æ¯”æµ‹è¯•å®Œæˆ');
            }, 12000);
        }
        
        // ========== åœæ­¢å‡½æ•° ==========
        
        function stopCustom() {
            if (customEventSource) {
                customEventSource.close();
                updateStatus('custom', 'error', 'æ‰‹åŠ¨åœæ­¢');
            }
        }
        
        function stopServerSent() {
            if (serverSentEventSource) {
                serverSentEventSource.close();
                updateStatus('serverSent', 'error', 'æ‰‹åŠ¨åœæ­¢');
            }
        }
        
        function stopCustomEvent() {
            if (customEventObjectSource) {
                customEventObjectSource.close();
                updateStatus('customEvent', 'error', 'æ‰‹åŠ¨åœæ­¢');
            }
        }
        
        function stopAiCompare() {
            updateStatus('aiCompare', 'error', 'æ‰‹åŠ¨åœæ­¢');
        }
        
        function stopUploadCompare() {
            updateStatus('uploadCompare', 'error', 'å–æ¶ˆä¸Šä¼ ');
            if (document.getElementById('uploadProgress')) {
                document.getElementById('uploadProgress').style.width = '0%';
            }
        }
        
        function stopTraditional() {
            if (traditionalEventSource) {
                traditionalEventSource.close();
            }
            updateStatus('traditional', 'error', 'æ‰‹åŠ¨åœæ­¢');
        }
    </script>
</body>
</html>